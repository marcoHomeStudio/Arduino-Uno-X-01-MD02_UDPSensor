<h1><span style="font-weight: 400;">ArduinoUno/EthernetShield XY-MD02 UDP Sensor</span></h1>
<p><span style="font-weight: 400; color: #ff0000;">July 16, 2021</span></p>
<h2><span style="font-weight: 400;">Overview</span></h2>
<p><span style="font-weight: 400;">Building a sensor based on <span style="color: #333399;"><strong><em>Arduino Uno MCU</em></strong> </span>controller board with it&rsquo;s attached <span style="color: #333399;"><strong><em>Arduino Ethernet shield</em></strong></span> to connect an <span style="color: #333399;"><strong><em>XY-MD02 sensor</em></strong></span> to an <span style="color: #333399;"><strong><em>UDP server</em></strong></span> via a dedicated UDP port.<br />The XY-MD02 sensor is connected to the arduino uno board via a <span style="color: #333399;"><strong><em>RS485 serial interface</em></strong></span>. The RS 485 serial interface is based on a <span style="color: #333399;"><strong><em>MAX-485 chip</em></strong></span>.<br />The Arduino Uno is providing the +5Vdc VCC and GND to both the R485 module and the sensor.<br />It is only for the testing and development of the sensor. <br />In a real case deployment the power supply of the XY-MD02 sensor is going to be a separated power supply. The two system Arduino and XY-MD02 doesn&rsquo;t need to be grounded together and a two wire twisted cable is enough to ensure the serial communication up to 800m. <br />For the ease of testing and development we will use only <span style="color: #333399;"><strong><em>one VCC and one Ground </em></strong></span>to power the all system.<br />The XY-MD02 sensor can use either the standard <span style="color: #333399;"><strong><em>modbus serial</em></strong></span> protocol or a standard <strong><em><span style="color: #333399;">serial UART</span> </em></strong>protocol. Because the sensor is not meant to be used in an array of sensors connected to the same RS485 two wire bus, it is much easier to communicate with the sensor using a <strong><span style="color: #333399;">simple text UART serial protocol</span>.</strong><strong><br /></strong></span></p>
<hr />
<h2><span style="font-weight: 400;">Schematic:</span></h2>
<p><span style="font-weight: 400;"> <img src="/images/image4.png" alt="" /></span></p>
<h2><span style="font-weight: 400;">Hardware requirement:</span></h2>
<hr />
<h4><span style="font-weight: 400;">Arduino Uno:</span></h4>
<p><span style="font-weight: 400;"><img src="/images/image3.jpg" alt="" /></span></p>
<h4><span style="font-weight: 400;">Arduino Ethernet shield:</span></h4>
<p><span style="font-weight: 400;"><img src="/images/image6.jpg" alt="" /></span></p>
<h4><span style="font-weight: 400;">Serial TTL To RS485 Module Converter Auto flow control MAX485:</span></h4>
<p><span style="font-weight: 400;"><img src="/images/image2.jpg" alt="" /></span></p>
<h4><span style="font-weight: 400;">XY-MD002 sensor: :</span></h4>
<p><span style="font-weight: 400;"><img src="/images/image5.jpg" alt="" /></span></p>
<h2><span style="font-weight: 400;">Remarks about the Serial TTL To RS485 Module Converter Auto flow control MAX485 module: :</span></h2>
<p><span style="font-weight: 400;">This module is easier to use compared to a normal MAX485 module because of its </span><span style="color: #333399;"><strong><em>Auto flow control</em></strong></span><span style="font-weight: 400;">. It needs only </span><span style="color: #333399;"><strong><em>one RX and One TX</em></strong></span><span style="font-weight: 400;"> connection to directly communicate through RS485 lines. Conventional MAX 485 uses two more lines to be able to communicate through the RS485 communication line. It needs one driver enable line (high enable) and one Receiver enable line (Low enable) These two lines are normally used to select the sending or receiving mode of the RS485 protocol. Rs 485 is not full duplex and this line allows you to select which mode the module is in. </span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">With the Auto flow control of the MAX485, the module itself takes care of this part of the communication, simplifying the programmation. </span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">However I did not try to use the Modbus RS485 protocol with the auto flow control capability and further testing must be performed to validate it.</span></p>
<p><span style="font-weight: 400;">The silk screen printing on the module uses unconventional RX and TX labeling, therefore the </span><span style="color: #333399;"><strong><em>TX</em></strong></span><span style="font-weight: 400;"> of the module must be connected to the </span><span style="color: #333399;"><strong><em>TX</em></strong></span><span style="font-weight: 400;"> of the arduino and the </span><span style="color: #333399;"><strong><em>RX</em></strong></span><span style="font-weight: 400;"> of the module must be connected to the </span><span style="color: #333399;"><strong><em>RX</em></strong></span><span style="font-weight: 400;"> of the arduino.</span></p>
<p><span style="font-weight: 400;">The two wires of the RS485 line must be </span><span style="color: #333399;"><strong><em>twisted </em></strong></span><span style="font-weight: 400;">to work properly for a long distance.</span></p>
<h2><span style="font-weight: 400;">Remarks about the Arduino Uno UART:</span></h2>
<p><span style="font-weight: 400;">RS485 protocol is working only on </span><span style="color: #333399;"><strong><em>physical UART</em></strong></span><span style="font-weight: 400;"> and </span><strong><em>Software serial</em></strong><span style="font-weight: 400;"> library </span><span style="color: #333399;"><strong><em>can&rsquo;t be used</em></strong></span><span style="font-weight: 400;"> with the RS485 communication protocol.</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">The Arduino Uno got only one physical UART connected to the pin0 and 1. It&rsquo;s the same port which is used for the USB upload and the serial monitor. Therefore each time you want to upload the code from the Arduino IDE via the USB port you must disconnect the sensor from the RX/TX pins of the board otherwise the upload will fail.</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">The Arduino serial monitor can&rsquo;t be used simultaneously with the RS485 module connected to the RX/TX pin of the Arduino board.</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">If you want to avoid this problem you should upgrade your board to an Arduino Mega which offers 4 physical serial ports on 8 different pins.</span></p>
<hr />
<h1><span style="font-weight: 400;">Before uploading the code:</span></h1>
<p><span style="font-weight: 400;">Before uploading the code please modify the following to match your configuration:</span></p>
<h2><span style="font-weight: 400;">Mac Address:</span></h2>
<p><span style="font-weight: 400;">If you need a specific MAC address due to your firewall restriction please modify the following:</span><span style="font-weight: 400;"><br /></span><em><span style="font-weight: 400;">byte</span><span style="font-weight: 400;"> mac[] = {</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">&nbsp; </span><span style="font-weight: 400;">0xDE</span><span style="font-weight: 400;">, </span><span style="font-weight: 400;">0xAD</span><span style="font-weight: 400;">, </span><span style="font-weight: 400;">0xBE</span><span style="font-weight: 400;">, </span><span style="font-weight: 400;">0xEF</span><span style="font-weight: 400;">, </span><span style="font-weight: 400;">0xFE</span><span style="font-weight: 400;">, </span><span style="font-weight: 400;">0xED</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">};</span></em></p>
<h2><span style="font-weight: 400;">IP address:</span></h2>
<p><span style="font-weight: 400;">Modify the following to match your net<em>work requirement</em></span><em><span style="font-weight: 400;"><br /></span></em><span style="font-weight: 400;">IPAddress</span><span style="font-weight: 400;"> ip(</span><span style="font-weight: 400;">192</span><span style="font-weight: 400;">, </span><span style="font-weight: 400;">168</span><span style="font-weight: 400;">, </span><span style="font-weight: 400;">1</span><span style="font-weight: 400;">, </span><span style="font-weight: 400;">177</span><span style="font-weight: 400;">);</span><span style="font-weight: 400;"><br /><br /></span></p>
<h2><span style="font-weight: 400;">UDP server port:</span></h2>
<p><span style="font-weight: 400;">Modify the following to match your UDP server listening port&nbsp;</span></p>
<p><span style="font-weight: 400;">unsigned</span> <span style="font-weight: 400;">int</span><span style="font-weight: 400;"> udpPort = </span><span style="font-weight: 400;">8888</span><span style="font-weight: 400;">;&nbsp; &nbsp; &nbsp; </span><span style="font-weight: 400;">// Your UDP port</span></p>
<p><span style="font-weight: 400;">&nbsp;</span></p>
<h2><span style="font-weight: 400;">UDP server port or lan address :</span></h2>
<p><span style="font-weight: 400;">If you want to use network name UNC instead of ip address, uncomment the following&nbsp;</span></p>
<p><span style="font-weight: 400;">//char udpServer[]="myUDPserver";&nbsp;</span></p>
<p><span style="font-weight: 400;">and replace &ldquo;myUDPserver&rdquo; by your server name and comment the following line</span></p>
<p><span style="font-weight: 400;">byte</span><span style="font-weight: 400;">&nbsp; udpServer[</span><span style="font-weight: 400;">4</span><span style="font-weight: 400;">]={</span><span style="font-weight: 400;">192</span><span style="font-weight: 400;">,</span><span style="font-weight: 400;">168</span><span style="font-weight: 400;">,</span><span style="font-weight: 400;">1</span><span style="font-weight: 400;">,</span><span style="font-weight: 400;">61</span><span style="font-weight: 400;">};</span></p>
<p><span style="font-weight: 400;">&nbsp;</span></p>
<p><span style="font-weight: 400;">If you want to use IP address instead of network name keep the following commented: </span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">//char udpServer[]="myUDPserver";</span></p>
<p><span style="font-weight: 400;">And change the following to match your UDP server port.</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">byte</span><span style="font-weight: 400;">&nbsp; udpServer[</span><span style="font-weight: 400;">4</span><span style="font-weight: 400;">]={</span><span style="font-weight: 400;">192</span><span style="font-weight: 400;">,</span><span style="font-weight: 400;">168</span><span style="font-weight: 400;">,</span><span style="font-weight: 400;">1</span><span style="font-weight: 400;">,</span><span style="font-weight: 400;">61</span><span style="font-weight: 400;">};</span></p>
<p><span style="font-weight: 400;">&nbsp;</span></p>
<h2><span style="font-weight: 400;">Sampling rate:</span></h2>
<p><span style="font-weight: 400;">Modify the following to match your sampling rate needed:</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">unsigned</span> <span style="font-weight: 400;">int</span><span style="font-weight: 400;"> samplerate=</span><span style="font-weight: 400;">3000</span><span style="font-weight: 400;">;</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">The sampling rate is in milliseconds. 3000 = one reading every 3s.</span></p>
<hr />
<h1><span style="font-weight: 400;">Uploading the code:</span></h1>
<p><span style="font-weight: 400;">Before uploading the code select the proper board and port in the Arduino IDE software by selecting </span><span style="color: #333399;"><strong><em>Tools/Board/Arduino Uno</em></strong></span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">And </span><span style="color: #333399;"><strong><em>Tools/Port/ </em></strong><strong><em>&ldquo;YourCom port&rdquo;</em></strong></span></p>
<p><span style="font-weight: 400;">Remember to disconnect the sensor for </span><span style="color: #333399;"><strong><em>TX/RX (pin 0 and 1) </em></strong></span><span style="font-weight: 400;">from the arduino before uploading via the USB port otherwise the upload will fail.</span></p>
<p><span style="font-weight: 400;">Once the upload is successful, disconnect the USB port and </span><span style="text-decoration: underline;"><strong><em>reconnect the TX/RX pin to the RS485 module.</em></strong></span><strong><em><br /></em></strong><span style="font-weight: 400;">To start the sensor just plug the USB port to power the system.</span><span style="font-weight: 400;"><br /><br /></span></p>
<h1><span style="font-weight: 400;">Reading the datas:</span></h1>
<p><span style="font-weight: 400;">Once the system is powered from the USB port, the sensor will send to your UDP server on the selected UDP port a string containing the data every sample rate defined in the </span><em><span style="font-weight: 400;">samplerate</span></em><span style="font-weight: 400;"> variable.</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">The string is formatted as follow: <span style="color: #333399;">&ldquo;</span></span><span style="color: #333399;"><strong><em>XX.X</em></strong><strong><em>&deg;C</em></strong><span style="font-weight: 400;">,</span><strong><em>YY.Y</em></strong><strong><em>%</em></strong></span><span style="font-weight: 400;">&rdquo; followed by the character &ldquo;CRLF&rdquo; (Carriage line feed}</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">Where </span><span style="color: #333399;"><strong><em>XX.X</em></strong></span><span style="font-weight: 400;"> is the temperature id degre celsius and </span><span style="color: #333399;"><strong><em>YY.Y</em></strong></span><span style="font-weight: 400;"> is the humidity in percent.</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">The temperature and humidity are a 1 digit float from 0.0 to 99.9.</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">A &ldquo;,&rdquo; (comma character) is used to split the two measurement</span></p>
<h2><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">Remark:</span></h2>
<p><span style="font-weight: 400;">The character &ldquo;</span><strong><em>&deg;</em></strong><span style="font-weight: 400;">&rdquo; is not a regular character and is depending on the ASCII table used by your system. The ASCII code of &ldquo;</span><span style="color: #333399;"><strong>&deg;</strong></span><span style="font-weight: 400;">&rdquo; should be </span><span style="color: #333399;"><strong><em>alt 248</em></strong></span><span style="font-weight: 400;">.</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">It is possible that your system read the following string instead: <span style="color: #333399;"><em><strong>&rdquo;27.8��,72.6%&rdquo;</strong></em></span></span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">Nevertheless the string format will be always the same:</span><span style="font-weight: 400;"><br /></span><span style="color: #333399;"><span style="font-weight: 400;">[</span><strong><em>Digit] [Digit] [dot] [Digit] [Char] [Char] [Comma] [Digit] [Digit] [Dot] [Digit] [Char]</em></strong></span></p>
<p><span style="font-weight: 400;">&nbsp;</span></p>
<h1><span style="font-weight: 400;">String command available for the XY-MD02 sensor:</span></h1>
<p><span style="font-weight: 400;">You can send the following command to the sensor using a simple </span><span style="font-weight: 400;">Serial</span><span style="font-weight: 400;">.</span><span style="font-weight: 400;">print</span><span style="font-weight: 400;">(</span><span style="font-weight: 400;">"</span><span style="color: #333399;"><strong><em>COMMAND</em></strong></span><span style="font-weight: 400;">"</span><span style="font-weight: 400;">)</span></p>
<p><span style="font-weight: 400;">Example: </span><span style="color: #333399;"><em><strong>Serial.print("READ")</strong></em></span><span style="font-weight: 400;"> will read the data from the sensor.</span></p>
<p><span style="font-weight: 400;">The following command are available:</span></p>
<p><strong><em>READ </em></strong><span style="font-weight: 400;">: Read temperature and humidity</span><span style="font-weight: 400;"><br /></span><strong><em>AUTO</em></strong><span style="font-weight: 400;">: start the temperature and humidity automatic report function</span><span style="font-weight: 400;"><br /></span><strong><em>STOP</em></strong><span style="font-weight: 400;">: start the temperature and humidity automatic report function</span><span style="font-weight: 400;"><br /></span><span style="font-weight: 400;">This two function allow you to read the data between the start and stop command and the data will be sent at once after receiving the stop command according to the frequency rate define by the command HZ (see below)</span><span style="font-weight: 400;"><br /></span><strong><em>BR:XXXX</em></strong><span style="font-weight: 400;"> Set the baud rate between 9600 and 19200</span><span style="font-weight: 400;"><br /></span><strong><em>TC:XX.X</em></strong><span style="font-weight: 400;"> set the temperature calibration (-10.0 to 10.0)</span><span style="font-weight: 400;"><br /></span><strong><em>HC:XX.X </em></strong><span style="font-weight: 400;">set the humidity calibration (-10.0 to 10.0)</span><span style="font-weight: 400;"><br /></span><strong><em>HZ:XXX</em></strong><span style="font-weight: 400;"> set the temperature humidity reporting rate (0.5, 1, 2, 5 ,10)</span><span style="font-weight: 400;"><br /></span><strong><em>PARAM</em></strong><span style="font-weight: 400;"> Read the system current set value</span></p>
<h2><span style="font-weight: 400;">Sensor UART serial port default setup:</span></h2>
<p><span style="font-weight: 400;">By default the UART of the sensor is set to:</span><span style="font-weight: 400;"><br /></span><strong><em>Baud rate</em></strong><span style="font-weight: 400;">: </span><strong>9600</strong><strong><br /></strong><strong><em>Bit</em></strong><span style="font-weight: 400;">:</span><strong> 8</strong><span style="font-weight: 400;"><br /></span><strong><em>Stop bit</em></strong><span style="font-weight: 400;">: </span><strong>1</strong><strong><br /></strong><strong><em>Check bit</em></strong><span style="font-weight: 400;">: </span><strong>No</strong><strong><br /><br /></strong></p>
